<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/assets/css/controls.css">
	<title>Request Songs</title>
</head>
<body>

	<form id="search">
		<input name="search" type="search" placeholder="Search For..."/>
		<select name="service">
			<option value="youtube">Youtube</option>
			<option value="soundcloud">Soundcloud</option>
		</select>
	</form>
	<div id="results"></div>
	<input id="more" type="button" value="Load More" data-pageCode/>


	<script type="text/html" id="tmlp-song">
		<div>
			<h1>{{title}}</h1>
			<img src="{{thumbnail}" style="float:left">
			<div style="clear:left">{{description}}</div>
			<input class="submitRequest" type="button" data-id="{{id}}" data-type="{{type}}" value="Request"/>
		</div>
	</script>

	<script src="/assets/js/vendor.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
	<script>
		function addSongs(items,loadNextPage){
			var template = $("#tmlp-song").html();
			$.each(items,function(){
				$("#results").append(
					$("<li>").html(Mustache.render(template,this))
				)
			});
			$("#more").off("click").one("click",loadNextPage);
		}

		var youtubeSearch = (function(query,pageToken){
			var API_KEY = 'AIzaSyDg5EAtlN6aAHNmvcA53iBGPe0Mx0OzvqA';
			var API_ENDPOINT= 'https://www.googleapis.com/youtube/v3/search';
			var params = {
				q: query,
				pageToken: pageToken,
				part: "snippet",
				key: API_KEY
			};
			$.getJSON(API_ENDPOINT,params,function(resp){
				var items = $.map(resp.items,function(v){
					return {
						title: v.snippet.title,
						thumbnail: v.snippet.thumbnails.default.url,
						description: v.snippet.description,
						id: v.id.videoId,
						type: "youtube"
					}
				})
				addSongs(items,function(){youtubeSearch(query,resp.nextPageToken)})
			})
		}

		var soundcloudSearch = function(query,offset){
			var API_KEY = "fbab4fa264979594df9f5cda9fd1fa3d";
			var API_ENDPOINT = "https://api.soundcloud.com/tracks";
			if(offset === undefined){
				offset=0
			}
			var params = {
				q: query,
				offset:offset,
				client_id: API_KEY
			};
			$.getJSON(API_ENDPOINT,params,function(resp){
				var items = $.map(resp,function(v){
					return {
						title: v.title,
						thumbnail: v.artwork_url,
						description: v.description,
						id: v.id,
						type: "soundcloud"
					}
				})
				addSongs(items,function(){soundcloudSearch(query,offset+items.length)})
			})
		}

		/*
		function pagedResponse(data,method,params){
			$.extend(this,data)
			this._request = {method:method,params:params};
		}
		pagedResponse.prototype.nextPage=function(){
				var params = $.extend({},this._request.params,{pageToken:this.nextPageToken})
				return youtubeApiCall(this._request.method,params)
		}
		function youtubeApiCall(method,params){
			params.key = API_KEY;
			return new Promise(function(good,bad){
				$.getJSON(API_BASE+method,params,function(resp){
					good(new pagedResponse(resp,method,params))
				}).fail(bad)
			})
		}
		var searchVideo = q=> youtubeApiCall("search",{q:q,part:"snippet"});
		var nextSearchPage = p=> youtubeApiCall("search",{pageToken:p,part:"snippet"})
		*/

 		var socket = io();
		$("#search").on("submit",function(e){
			$("#results").empty();
			var $t = $(this),
					query = $t.find("[name=search]").val(),
					service = $t.find("[name=service]").val();
			switch (service){
				case "youtube": youtubeSearch(query); break;
				case "soundcloud": soundcloudSearch(query); break;
				default: console.warn("Bad Service",service);
			}
			e.preventDefault();
		})

		$("#results").on("click",".submitRequest",function(e){
			var $t = $(this);
			socket.emit("request",$t.attr("data-type"),$t.attr("data-id"));
			e.preventDefault();
		})
	</script>

</body>
</html>
