<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/assets/css/controls.css">
	<title>Request Songs</title>
</head>
<body>

	<form id="search">
		<input name="search" type="search" placeholder="Search For..."/>
	</form>
	<div id="results"></div>
	<input id="more" type="button" value="Load More" data-pageCode/>


	<script type="text/html" id="tmlp-youtubeVideo">
		<div>
			<h1>{{snippet.title}}</h1>
			<img src="{{snippet.thumbnails.default.url}}" style="float:left">
			<div style="clear:left">{{snippet.description}}</div>
			<input class="youtubeRequest" type="button" data-request-id="{{id.videoId}}">Request</input>
		</div>
	</script>

	<script src="/assets/js/vendor.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
	<script>
		var API_KEY = 'AIzaSyDg5EAtlN6aAHNmvcA53iBGPe0Mx0OzvqA';
		var API_BASE= 'https://www.googleapis.com/youtube/v3/'
		function pagedResponse(data,method,params){
			$.extend(this,data)
			this._request = {method:method,params:params};
		}
		pagedResponse.prototype.nextPage=function(){
				var params = $.extend({},this._request.params,{pageToken:this.nextPageToken})
				return youtubeApiCall(this._request.method,params)
		}
		function youtubeApiCall(method,params){
			params.key = API_KEY;
			return new Promise(function(good,bad){
				$.getJSON(API_BASE+method,params,function(resp){
					good(new pagedResponse(resp,method,params))
				}).fail(bad)
			})
		}
		var searchVideo = q=> youtubeApiCall("search",{q:q,part:"snippet"});
		var nextSearchPage = p=> youtubeApiCall("search",{pageToken:p,part:"snippet"})

 		var socket = io();
		$("#search").on("submit",function(e){
			$("#results").empty();
			searchVideo($(this).find("[name=search]").val())
				.then(searchResults)
				.catch(function(e){console.error(e)})
			e.preventDefault();
		})

		$("#results").on("click",".youtubeRequest",function(e){
			socket.emit("request","youtube",$(this).attr("data-request-id"));
			e.preventDefault();
		})

		function searchResults(resp){
			$("#more").attr("data-pageCode",resp.nextPageToken)
			var template = $("#tmlp-youtubeVideo").html();
			$.each(resp.items,function(){
				$("#results").append(
					$("<li>").html(Mustache.render(template,this))
				)
			})
			$("#more").off("click").one("click",function(){
				resp.nextPage().then(searchResults).catch(function(e){console.error(e)})
			})
		}
	</script>

</body>
</html>
